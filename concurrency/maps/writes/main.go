// Package main демонстрирует проблему конкурентной записи в map и ее решение с помощью sync.Mutex.
//
// ПРОБЛЕМА: Стандартные map в Go НЕ являются потокобезопасными.
// Если несколько горутин одновременно пытаются записать данные в одну и ту же карту,
// это приведет к состоянию гонки (data race) и панике (panic) во время выполнения.
//
// РЕШЕНИЕ: Использовать мьютекс (`sync.Mutex`) для защиты доступа к карте.
// Мьютекс гарантирует, что в каждый момент времени только одна горутина может
// выполнять код, находящийся между `mu.Lock()` и `mu.Unlock()`.
package main

import (
	"fmt"
	"sync"
)

func main() {
	const writes = 1000
	// Создаем карту для хранения данных.
	storage := make(map[int]int, writes)

	// wg будет ожидать завершения всех горутин.
	var wg sync.WaitGroup
	// mu — это мьютекс для защиты карты `storage`.
	var mu sync.Mutex

	wg.Add(writes)
	fmt.Printf("Запуск %d горутин для записи в карту...\n", writes)

	for i := 0; i < writes; i++ {
		go func(workerID int) {
			defer wg.Done()

			// ВАЖНАЯ ОШИБКА, КОТОРАЯ БЫЛА ИСПРАВЛЕНА:
			// Исходный код использовал `i` напрямую внутри горутины. Это привело бы к тому,
			// что большинство горутин получили бы последнее значение `i` из цикла,
			// и в карту записалось бы только одно или несколько значений.
			// ПРАВИЛЬНОЕ РЕШЕНИЕ: передать `i` как аргумент `workerID` в горутину,
			// чтобы каждая горутина получила уникальное значение.

			// Блокируем мьютекс перед доступом к карте.
			// Теперь только эта горутина может работать с картой.
			mu.Lock()
			// `defer mu.Unlock()` гарантирует, что мьютекс будет разблокирован
			// при выходе из функции, даже если произойдет паника.
			defer mu.Unlock()

			// Этот блок кода между Lock и Unlock называется "критической секцией".
			storage[workerID] = workerID

		}(i) // Передаем `i` как аргумент.
	}

	// Ожидаем, пока все горутины завершат свою работу.
	wg.Wait()

	fmt.Printf("Запись завершена. Итоговый размер карты: %d\n", len(storage))

	// Если бы не было исправления с передачей `i` как аргумента,
	// len(storage) был бы намного меньше 1000.
	// fmt.Println(storage) // Раскомментируйте, чтобы увидеть содержимое карты.
}
