// Package main демонстрирует создание простого анимационного спиннера в командной строке
// для индикации того, что программа выполняет долгую фоновую задачу.
package main

import (
	"fmt"
	"sync"
	"time"
)

// spinner отображает анимацию в одной строке до тех пор, пока не получит сигнал о завершении.
func spinner(wg *sync.WaitGroup, done <-chan struct{}) {
	defer wg.Done()
	// Ticker будет срабатывать каждые 100 миллисекунд, задавая скорость анимации.
	ticker := time.NewTicker(100 * time.Millisecond)
	defer ticker.Stop()

	// Строка с символами для анимации.
	animationChars := `-\|/`
	i := 0

	for {
		select {
		case <-done:
			// Канал `done` был закрыт, что является сигналом к завершению.
			// Очищаем строку и выходим из цикла.
			fmt.Print("\r \r") // Сначала очищаем символ, потом возвращаем курсор.
			return
		case <-ticker.C:
			// Подошло время для следующего кадра анимации.
			char := animationChars[i%len(animationChars)]
			// `\r` (carriage return) — это управляющий символ, который возвращает
			// курсор в начало текущей строки без перехода на новую.
			// Это позволяет следующей операции печати перезаписать существующий символ.
			fmt.Printf("\r%c", char)
			i++
		}
	}
}

// fib — это намеренно неэффективная рекурсивная реализация чисел Фибоначчи.
// Ее медленная работа для больших `n` позволяет наглядно продемонстрировать
// работу спиннера во время долгого вычисления.
func fib(x int) int {
	if x < 2 {
		return x
	}
	return fib(x-1) + fib(x-2)
}

func main() {
	var wg sync.WaitGroup
	// `done` — это канал, который будет использоваться для graceful shutdown спиннера.
	done := make(chan struct{})

	wg.Add(1)
	// Запускаем спиннер в отдельной горутине.
	go spinner(&wg, done)

	// Выполняем долгую задачу в основной горутине.
	const n = 45
	fibN := fib(n)

	// После завершения задачи отправляем сигнал спиннеру.
	// Закрытие канала — это широковещательный сигнал для всех, кто его слушает.
	close(done)
	// Ожидаем, пока горутина спиннера полностью завершится и очистит свой вывод.
	// Это предотвращает "загрязнение" финального вывода.
	wg.Wait()

	// Выводим результат. Используем Printf для форматирования строки.
	fmt.Printf("Fibonacci(%d) = %d\n", n, fibN)
}
